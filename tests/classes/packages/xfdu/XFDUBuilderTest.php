<?php

require_once dirname(__FILE__) . '/../../../../curation_tool.inc';

/**
 * Test class for XFDUBuilder.
 * Generated by PHPUnit on 2012-04-04 at 21:30:31.
 */
class XFDUBuilderTest extends PHPUnit_Framework_TestCase {

  /**
   * @var XFDUBuilder
   */
  protected $object;

  /**
   * Sets up the fixture, for example, opens a network connection.
   * This method is called before a test is executed.
   */
  protected function setUp() {
    $this->object = new XFDUBuilder;
  }

  /**
   * Tears down the fixture, for example, closes a network connection.
   * This method is called after a test is executed.
   */
  protected function tearDown() {
    
  }

  /**
   * 
   */
  public function testBuild_xfdu() {
    $settings = new XFDUSetup();
    $settings->packageHeaderID = 'packageID';
    $xfdu = new XFDU();
    $xfdu = $this->object->build_xfdu($settings);
    
    $this->assertTrue($xfdu->isset_packageHeader());
    $packageHeader = $xfdu->get_packageHeader();
    $this->assertTrue($packageHeader->isset_volumeInfo());
    $volumeInfo = $packageHeader->get_volumeInfo();
    $this->assertTrue($volumeInfo->isset_specificationVersion());
    $this->assertEquals('1.0', $volumeInfo->get_specificationVersion());
    $this->assertEquals('packageID', $packageHeader->get_id());
    $this->assertTrue($xfdu->isset_informationPackageMap());
    $this->assertTrue($xfdu->isset_metadataSection());
    $this->assertTrue($xfdu->isset_dataObjectSection());
    $this->assertTrue($xfdu->isset_behaviorSection());
  }
  
  /**
   * 
   */
  public function testBuild_xfduNoPackageID() {
    $settings = new XFDUSetup();
    $xfdu = new XFDU();
    $xfdu = $this->object->build_xfdu($settings);
    
    $this->assertTrue($xfdu->isset_packageHeader());
    $packageHeader = $xfdu->get_packageHeader();
    $this->assertTrue($packageHeader->isset_volumeInfo());
    $volumeInfo = $packageHeader->get_volumeInfo();
    $this->assertTrue($volumeInfo->isset_specificationVersion());
    $this->assertEquals('1.0', $volumeInfo->get_specificationVersion());
    $this->assertEquals('packageHeader', $packageHeader->get_id());
  }
  
  /**
   * 
   */
  public function testBuild_xfduWithSequence() {
    $settings = new XFDUSetup();
    $settings->sequenceSize = 3;
    $settings->sequencePosition = 2;
    $settings->sequenceInfoText = '2 of 3';
    $xfdu = new XFDU();
    $xfdu = $this->object->build_xfdu($settings);
    
    $this->assertEquals(
            $settings->sequenceSize,
            $xfdu->get_packageHeader()->get_volumeInfo()->get_sequenceInformation()->get_sequenceSize()
            );
    
    
    $this->assertEquals(
            $settings->sequencePosition,
            $xfdu->get_packageHeader()->get_volumeInfo()->get_sequenceInformation()->get_sequencePosition()
            );
    
    $this->assertEquals(
            $settings->sequenceInfoText, 
            $xfdu->get_packageHeader()->get_volumeInfo()->get_sequenceInformation()->get_value());
  }
  
  /**
   * 
   */
  public function testBuild_xfduWithExtension() {
    $namespace = new XMLNameSpace();
    $namespace->set_prefix('ns1');
    $namespace->set_uri('namespace1');
    
    $dom = new DOMDocument('1.0', 'UTF-8');
    $dom->appendChild($extension = $dom->createElement('extension'));
    $extension->appendChild($dom->createElement('child1'));
    $extension->appendChild($dom->createElement('child2'));
    $extension->appendChild($dom->createElement('child3'));
    $extension->setAttribute('xmlns:'.$namespace->get_prefix(), $namespace->get_uri());
    
    
    $xpath = new DOMXPath($dom);
    $query = '/extension/*';
    $any = $xpath->query($query);
    
    $settings = new XFDUSetup();
    $settings->extension = $any;
    $settings->extensionNamespaces = array($namespace);
    
    $this->assertEqualXMLStructure(
            $extension, 
            $this->object->
                         build_xfdu($settings)->
                         get_packageHeader()->
                         get_environmentInfo()->
                         get_extension()->
                         get_as_DOM(), 
            TRUE);
  }
  
  public function testBuild_xfduWithXMLData() {
    $dom = new DOMDocument('1.0', 'UTF-8');
    $dom->appendChild($xmlData = $dom->createElement('xmlData'));
    $xmlData->appendChild($dom->createElement('child1'));
    $xmlData->appendChild($dom->createElement('child2'));
    $xmlData->appendChild($dom->createElement('child3'));    
    
    $xpath = new DOMXPath($dom);
    $query = '/xmlData/*';
    $any = $xpath->query($query);    
    
    $settings = new XFDUSetup();
    $settings->xmlData = $any;
    
    $actual = $this->object->build_xfdu($settings)->
                         get_packageHeader()->
                         get_environmentInfo()->
                         get_xmlData()->
                         get_as_DOM();
    
    $this->assertEqualXMLStructure($xmlData, $actual, TRUE);
  }
  
  /**
   * 
   */
  public function testBuild_dataObjectPointer() {
    $doID = 'do1';
    
    $dom = new DOMDocument('1.0', 'UTF-8');
    $expected = $dom->createElement('dataObjectPointer');
    $expected->setAttribute('dataObjectID', $doID);
    
    $this->assertEqualXMLStructure($expected, $this->object->build_dataObjectPointer($doID)->get_as_DOM());
  }
  
  /**
   * 
   */
  public function testBuild_dataObjectPointerWithID() {
    $doID = 'do1';
    $id = 'id';
    
    $dom = new DOMDocument('1.0', 'UTF-8');
    $expected = $dom->createElement('dataObjectPointer');
    $expected->setAttribute('dataObjectID', $doID);
    $expected->setAttribute('ID', $id);
    
    $this->assertEqualXMLStructure($expected, $this->object->build_dataObjectPointer($doID, $id)->get_as_DOM());
  }
  
  /**
   * 
   */
  public function testBuild_contentUnitDataObjectPointer() {
    $doID = 'do1';
    $cuID = 'cu1';
    $id = 'id';
    
    $dom = new DOMDocument('1.0', 'UTF-8');
    $expected = $dom->createElement('xfdu:contentUnit');
    $expected->setAttribute('ID', $cuID);
    
    $expectedDO = $dom->createElement('dataObjectPointer');
    $expectedDO->setAttribute('ID', $id);
    $expectedDO->setAttribute('dataObjectID', $doID);
    
    $expected->appendChild($expectedDO);
    
    $dataObjectPointer = new DataObjectPointer();
    $dataObjectPointer->set_dataObjectID($doID);
    $dataObjectPointer->set_id($id);
    
    $this->assertEqualXMLStructure($expected, $this->object->build_contentUnit($cuID, $dataObjectPointer)->get_as_DOM());
  }
  
  /**
   *@expectedException InvalidArgumentException 
   */
  public function testBuild_contentUnitInvalidObject() {
    $this->object->build_contentUnit('id', new VolumeInfo());
  }

}

?>
